<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†é é¢</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
    <style>
    /* æ¯›ç»ç’ƒå°è¦½åˆ— */
    .blur-navbar {
      background: rgba(20, 20, 20, 0.55); /* åŠé€æ˜åº•è‰² */
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);

      border-bottom: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    /* è®“æ–‡å­—æ›´æ¸…æ¥š */
    .blur-navbar .navbar-brand,
    .blur-navbar .navbar-text,
    .blur-navbar .nav-link {
      color: #fff !important;
    }

    /* æŒ‰éˆ•åœ¨æ¨¡ç³ŠèƒŒæ™¯ä¸Šæ›´æ¸…æ¥š */
    .blur-navbar .btn-outline-light {
      border-color: rgba(255,255,255,0.7);
    }

    /* è®“ç®¡ç†é é¢çš„å€å¡Šæ¨™é¡Œæ›´æ¸…æ™° */
    h2 {
      font-weight: 700;
      color: #333;
      border-left: 5px solid #0d6efd; /* åŠ å…¥è—è‰²å´é‚Šæ¢æ¨™ç¤º */
      padding-left: 15px;
      margin-top: 2rem;
    }

    /* èª¿æ•´è¡¨æ ¼èˆ‡æ¸…å–®çš„åœ“è§’ */
    .list-group-item {
      border-radius: 8px !important;
      margin-bottom: 5px;
      border: 1px solid #eee;
    }

    /* æ‰‹æ©Ÿå°è¦½åˆ—å„ªåŒ– */
    @media (max-width: 991px) {

      .navbar-brand {
        font-size: 1.1rem !important;
      }

      .navbar-text {
        display: block;
        margin-top: 10px;
        opacity: 0.9;
      }

      .navbar .btn {
        font-size: 0.95rem;
        padding: 8px 12px;
      }
    }

  </style>

  <body class="container" style="padding-top:90px;">

  <!-- å°è¦½åˆ— -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container-fluid">

      <!-- å·¦å´æ¨™é¡Œ -->
      <a class="navbar-brand fs-4 fw-bold" href="{{ url_for('index') }}">
        ğŸµ ç·šä¸Šé»æ­Œè¡¨å–®ï¼ˆç®¡ç†ï¼‰
      </a>

      <!-- æ‰‹æ©Ÿç‰ˆæ¼¢å ¡æŒ‰éˆ• -->
      <button class="navbar-toggler" type="button"
              data-bs-toggle="collapse"
              data-bs-target="#adminNavbar"
              aria-controls="adminNavbar"
              aria-expanded="false"
              aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- å¯æ”¶åˆå€ -->
      <div class="collapse navbar-collapse" id="adminNavbar">
        <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">

          {% if session.get("user") %}

          <!-- ç®¡ç†å“¡è³‡è¨Š -->
          <li class="nav-item">
            <span class="navbar-text text-white small text-lg-normal me-lg-3">
              ğŸ‘¤ {{ session["user"]["email"] }}
            </span>
          </li>

          <!-- å›é¦–é  -->
          <li class="nav-item">
            <a href="{{ url_for('index') }}"
               class="btn btn-outline-light btn-sm w-100 w-lg-auto mt-2 mt-lg-0">
              å›é¦–é 
            </a>
          </li>

          <!-- ç™»å‡º -->
          <li class="nav-item">
            <a href="{{ url_for('logout') }}"
               class="btn btn-danger btn-sm w-100 w-lg-auto mt-2 mt-lg-0">
              ç™»å‡º
            </a>
          </li>

          {% endif %}
        </ul>
      </div>
    </div>
  </nav>
  
  <!-- ç³»çµ±è¨­å®š -->
  <h2 class="mb-4 mt-4">ç³»çµ±ç®¡ç†è¨­å®š</h2>
  <form id="configForm">
    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="acceptResponses">
      <label class="form-check-label" for="acceptResponses">æ˜¯å¦æ¥å—å›æ‡‰</label>
    </div>
    <div class="mb-3">
      <label for="deadlineDate" class="form-label">æˆªæ­¢æ—¥æœŸ</label>
      <input type="date" class="form-control" id="deadlineDate">
    </div>
    <div class="mb-3">
      <label for="deadlineTime" class="form-label">æˆªæ­¢æ™‚é–“</label>
      <input type="time" class="form-control" id="deadlineTime" step="1">
    </div>
    <button type="submit" class="btn btn-primary">æ›´æ–°è¨­å®š</button>
  </form>

  <hr class="my-4">

  <!-- é€šçŸ¥è¨­å®š -->
  <h2 class="mb-4">é€šçŸ¥è¨­å®š</h2>
  <form id="notifyForm">
    <div class="mb-3">
      <label for="notificationContent" class="form-label">è‡ªè¨‚é€šçŸ¥å…§å®¹</label>
      <textarea class="form-control" id="notificationContent" rows="6" style="font-family: monospace;"></textarea>
    </div>
    <div class="mb-3">
      <label for="version" class="form-label">ç‰ˆæœ¬è™Ÿ (æ ¼å¼ x.y.z)</label>
      <input type="text" class="form-control" id="version" placeholder="ä¾‹å¦‚ï¼š1.0.0">
    </div>
    <button type="submit" class="btn btn-primary">æ›´æ–°é€šçŸ¥</button>
  </form>

  <hr class="my-4">

  <!-- é™åˆ¶è¨­å®š -->
  <h2 class="mb-4">é™åˆ¶è¨­å®š</h2>
  <form id="limitForm">
    <div class="row mb-3">
      <div class="col-md-6">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="maleLimitEnabled">
          <label class="form-check-label" for="maleLimitEnabled">é™åˆ¶ç”·ç”Ÿé»æ­Œæ•¸é‡</label>
        </div>
        <input type="number" class="form-control mt-2" id="maleLimitCount" placeholder="ç”·ç”Ÿä¸Šé™ (é¦–)">
      </div>
      <div class="col-md-6">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="femaleLimitEnabled">
          <label class="form-check-label" for="femaleLimitEnabled">é™åˆ¶å¥³ç”Ÿé»æ­Œæ•¸é‡</label>
        </div>
        <input type="number" class="form-control mt-2" id="femaleLimitCount" placeholder="å¥³ç”Ÿä¸Šé™ (é¦–)">
      </div>
    </div>
    <button type="submit" class="btn btn-primary">æ›´æ–°é™åˆ¶</button>
  </form>
  
  <hr class="my-4">
  
  <!-- çµæœæ¸…å–® -->
  <h2 class="mb-3">æ”¶é›†åˆ°çš„çµæœ</h2>
  <div class="row g-2 mb-3">
    <div class="col-6 col-md-auto">
      <select id="genderFilter" class="form-select" onchange="loadResults()">
        <option value="">å…¨éƒ¨</option>
        <option value="ç”·">ç”·ç”Ÿ</option>
        <option value="å¥³">å¥³ç”Ÿ</option>
      </select>
    </div>
    <div class="col-6 col-md">
      <input type="number" id="searchId" class="form-control" placeholder="æœå°‹æ­Œæ›² ID">
    </div>
    <div class="col-6 col-md-auto">
      <button class="btn btn-info w-100" onclick="searchResult()">æœå°‹</button>
    </div>
    <div class="col-6 col-md-auto">
      <button class="btn btn-warning w-100" onclick="deleteAll()">åˆªé™¤å…¨éƒ¨çµæœ</button>
    </div>
    <div class="col-6 col-md-auto">
      <button class="btn btn-success w-100" onclick="exportExcel()">åŒ¯å‡º Excel</button>
    </div>
    <div class="col-6 col-md-auto">
      <button class="btn btn-outline-danger w-100" onclick="resetIds()">é‡ç½® ID</button>
    </div>
  </div>

  <ul id="resultsList" class="list-group mb-5"></ul>
  <p id="noResultMsg" class="text-muted" style="display:none;">æ‰¾ä¸åˆ°ç¬¦åˆçš„çµæœ</p>

  <!-- å½ˆå‡ºè¦–çª— -->
  <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resultModalLabel">ä½¿ç”¨è€…è©³ç´°å…§å®¹</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
        </div>
        <div class="modal-body">
          <p><strong>ID:</strong> <span id="detailId"></span></p>
          <p><strong>å§“å:</strong> <span id="detailName"></span></p>
          <p><strong>æ€§åˆ¥:</strong> <span id="detailGender"></span></p>
          <p><strong>æ­Œæ›²:</strong> <span id="detailSong"></span></p>
          <p><strong>Email:</strong> <span id="detailEmail"></span></p>
          <p><strong>é€£çµ:</strong> <a id="detailLink" href="#" target="_blank"></a></p>
          <p><strong>å¡«å¯«æ™‚é–“:</strong> <span id="detailTime"></span></p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" onclick="deleteCurrent()">åˆªé™¤æ­¤çµæœ</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS åŠŸèƒ½ -->
  <script>
    // è¼‰å…¥è¨­å®š
    function loadConfig() {
      fetch("/config")
        .then(res => res.json())
        .then(config => {
          document.getElementById("acceptResponses").checked = !!config.accept_responses;
          if (config.deadline && config.deadline.includes(" ")) {
            const [date, time] = config.deadline.split(" ");
            document.getElementById("deadlineDate").value = date;
            document.getElementById("deadlineTime").value = time;
          }
          document.getElementById("notificationContent").value = config.notification_content || "";
          document.getElementById("version").value = config.version || "1.0.0";
          document.getElementById("maleLimitEnabled").checked = !!config.male_limit_enabled;
          document.getElementById("maleLimitCount").value = config.male_limit_count || 0;
          document.getElementById("femaleLimitEnabled").checked = !!config.female_limit_enabled;
          document.getElementById("femaleLimitCount").value = config.female_limit_count || 0;
        });
    }

    // æ›´æ–°è¨­å®š
    function updateConfig(data, successMsg) {
      fetch("/config", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(data => data.success ? alert(successMsg) : alert("æ›´æ–°å¤±æ•—ï¼š" + data.error));
    }

    document.getElementById("configForm").addEventListener("submit", e => {
      e.preventDefault();
      const date = document.getElementById("deadlineDate").value;
      const time = document.getElementById("deadlineTime").value;
      const data = {
        accept_responses: document.getElementById("acceptResponses").checked,
        deadline: date && time ? `${date} ${time}` : ""
      };
      updateConfig(data, "è¨­å®šå·²æ›´æ–°");
    });

    document.getElementById("notifyForm").addEventListener("submit", e => {
      e.preventDefault();
      const data = {
        notification_content: document.getElementById("notificationContent").value,
        version: document.getElementById("version").value
      };
      updateConfig(data, "é€šçŸ¥å·²æ›´æ–°");
    });

    document.getElementById("limitForm").addEventListener("submit", e => {
      e.preventDefault();
      const data = {
        male_limit_enabled: document.getElementById("maleLimitEnabled").checked,
        male_limit_count: parseInt(document.getElementById("maleLimitCount").value) || 0,
        female_limit_enabled: document.getElementById("femaleLimitEnabled").checked,
        female_limit_count: parseInt(document.getElementById("femaleLimitCount").value) || 0
      };
      updateConfig(data, "é™åˆ¶è¨­å®šå·²æ›´æ–°");
    });
    
    // è¼‰å…¥çµæœ
    function loadResults() {
      const gender = document.getElementById("genderFilter").value;
      const url = gender ? `/results?gender=${gender}` : "/results";
      fetch(url).then(res => res.json()).then(renderList);
    }

    function searchResult() {
      const id = document.getElementById("searchId").value.trim();
      if (!id) return loadResults();
      fetch(`/result/${id}`)
        .then(res => res.json())
        .then(data => data.error ? renderList([]) : renderList([data]));
    }

    function renderList(data) {
      const list = document.getElementById("resultsList");
      list.innerHTML = "";
      document.getElementById("noResultMsg").style.display = data.length ? "none" : "block";
      data.forEach(item => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `<span><strong>${item.index || item.id}.</strong> ${item.name} - ${item.song}</span>
                        <button class="btn btn-sm btn-info" onclick="showDetail('${item.id}')">æŸ¥çœ‹è©³ç´°</button>`;
        list.appendChild(li);
      });
    }

    // --- Modal è©³ç´°å…§å®¹èˆ‡åˆªé™¤ ---
    function showDetail(id) {
      fetch(`/result/${id}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) return alert(data.error);
          document.getElementById("detailId").textContent = data.id;
          document.getElementById("detailName").textContent = data.name;
          document.getElementById("detailGender").textContent = data.gender;
          document.getElementById("detailSong").textContent = data.song;
          document.getElementById("detailEmail").textContent = data.email || "ç„¡";
          document.getElementById("detailLink").textContent = data.link;
          document.getElementById("detailLink").href = data.link;
          document.getElementById("detailTime").textContent = data.timestamp;
          window.currentId = data.id;

          new bootstrap.Modal(document.getElementById('resultModal')).show();
        });
    }

    function deleteCurrent() {
      if (!window.currentId || !confirm("ç¢ºå®šè¦åˆªé™¤æ­¤çµæœå—ï¼Ÿ")) return;
      fetch(`/delete/${window.currentId}`, { method: "DELETE" })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert("å·²åˆªé™¤");
            loadResults();
            bootstrap.Modal.getInstance(document.getElementById('resultModal')).hide();
          } else {
            alert("åˆªé™¤å¤±æ•—ï¼š" + data.error);
          }
        });
    }

    function deleteAll() {
      if (confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰çµæœå—ï¼Ÿæ­¤å‹•ä½œä¸å¯å¾©åŸï¼")) {
        fetch("/delete_all", { method: "DELETE" })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert("æ‰€æœ‰çµæœå·²åˆªé™¤");
              loadResults();
            }
          });
      }
    }

    function resetIds() {
      if (confirm("âš ï¸ ç¢ºå®šè¦é‡ç½®æ‰€æœ‰ ID å—ï¼Ÿ")) {
        fetch("/reset_ids", { method: "POST" })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              alert("âœ… æ‰€æœ‰ ID å·²é‡ç½®");
              loadResults();
            } else {
              alert("é‡ç½®å¤±æ•—ï¼š" + data.error);
            }
          });
      }
    }

    function exportExcel() {
      window.location.href = "/export";
    }

    // é é¢è¼‰å…¥æ™‚ â†’ åŒæ™‚è¼‰å…¥è¨­å®šèˆ‡çµæœ
    window.onload = () => {
      loadConfig();
      loadResults();
    };
  </script>
</body>
</html>
