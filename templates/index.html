<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>線上點歌表單</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="container mt-5">

<body class="container mt-5">

  <!-- 導覽列 -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="{{ url_for('index') }}">線上點歌表單</a>
      <div class="d-flex">
        {% if session.get("user") %}
          <span class="navbar-text me-2">目前登入：{{ session["user"]["userPrincipalName"] }}</span>
          <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary btn-sm">登出</a>
        {% else %}
          <!-- 未登入時只顯示「登入」按鈕，點擊後跳出選擇彈窗 -->
          <a href="#" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#loginModal">登入</a>
        {% endif %}
      </div>
    </div>
  </nav>

  <h2 class="mb-4">線上點歌</h2>
  <form id="songForm">
    <div class="mb-3">
      <label for="name" class="form-label">姓名</label>
      <input type="text" class="form-control" id="name" name="name" required>
    </div>

    <div class="mb-3">
      <label for="gender" class="form-label">性別</label>
      <select class="form-select" id="gender" name="gender" required>
        <option value="">請選擇</option>
        <option value="男">男</option>
        <option value="女">女</option>
      </select>
    </div>

    <!-- 歌曲名稱 + 建議清單 -->
    <div class="mb-3 position-relative">
      <label for="songName" class="form-label">歌曲名稱</label>
      <input type="text" class="form-control" id="songName" name="songName" required aria-autocomplete="list" aria-controls="songSuggestions">
      <!-- 建議清單會顯示在輸入框下方 -->
      <div id="songSuggestions" class="list-group position-absolute w-100" style="z-index:1000;" role="listbox"></div>
    </div>

    <div class="mb-3">
      <label for="songLink" class="form-label">Spotify 連結</label>
      <input type="url" class="form-control" id="songLink" name="songLink" required placeholder="https://open.spotify.com/..." >
    </div>

    <button type="submit" class="btn btn-primary">送出</button>
  </form>

  <!-- 回應送出成功的 Modal -->
  <div class="modal fade" id="submitModal" tabindex="-1" aria-labelledby="submitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="modal-header justify-content-center">
          <h5 class="modal-title" id="submitModalLabel">✅ 您的回應已送出</h5>
        </div>
        <div class="modal-body">
          <p>將會整理請求及排列歌曲</p>
          <button class="btn btn-primary" onclick="location.reload()">提交其他回應</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 通知彈窗 -->
  <div class="modal fade" id="notifyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">通知</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
  
        <div class="modal-body" id="notifyBody" style="white-space: pre-line;">
          {% if not session.get("user") %}
            <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">登入</a>
          {% endif %}
        </div>
  
        <div class="modal-footer">
          {% if session.get("user") %}
            <span class="me-2 text-success">您已登入：{{ session["user"]["email"] }}</span>
          {% endif %}
          <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">我知道了</button>
        </div>
      </div>
    </div>
  </div>
  <script>

  <!-- 登入選擇彈窗 -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">選擇登入方式</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <a href="{{ url_for('login_microsoft') }}" class="btn btn-primary w-100 mb-2">使用 Microsoft 登入</a>
          <a href="{{ url_for('login_google') }}" class="btn btn-danger w-100 mb-2">使用 Google 登入</a>
        </div>
      </div>
    </div>
  </div>

    // 表單送出
  document.getElementById("songForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const data = {
      name: document.getElementById("name").value,
      gender: document.getElementById("gender").value,
      songName: document.getElementById("songName").value,
      songLink: document.getElementById("songLink").value
    };

    fetch("/submit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const modal = new bootstrap.Modal(document.getElementById("submitModal"));
        modal.show();

        // 清空建議清單
        document.getElementById("songSuggestions").innerHTML = "";

        // 清空表單
        document.getElementById("songForm").reset();
      } else {
        alert("送出失敗：" + data.error);
      }
    })
    .catch(err => {
      console.error("提交失敗：", err);
      alert("送出發生錯誤，請稍後再試。");
    });
  });

  // 即時 Spotify 搜尋建議
  document.getElementById("songName").addEventListener("input", function() {
    const query = this.value.trim();
    const box = document.getElementById("songSuggestions");
    if (!query) {
      box.innerHTML = "";
      return;
    }

    fetch(`/search?q=${encodeURIComponent(query)}`)
      .then(res => res.json())
      .then(data => {
        box.innerHTML = "";
        data.forEach((item, idx) => {
          const a = document.createElement("a");
          a.className = "list-group-item list-group-item-action";
          a.setAttribute("role", "option");
          a.setAttribute("id", "suggestion-" + idx);
          a.innerHTML = `<strong>${item.name}</strong> - ${item.artist}`;
          a.href = "#";
          a.onclick = (e) => {
            e.preventDefault();
            document.getElementById("songName").value = item.name;
            document.getElementById("songLink").value = item.url;
            box.innerHTML = "";
          };
          box.appendChild(a);
        });
      })
      .catch(err => {
        console.error("搜尋建議錯誤：", err);
      });
  });

  function showNotification(config) {
    const deadline = config.deadline || "";
    const notifyContent = config.notification_content || "";
    const version = config.version || "1.0.0";

    let deadlineText = "";
    if (deadline && deadline.includes(" ")) {
      const [date, time] = deadline.split(" ");
      deadlineText = `回應收集到：${date} ${time}`;
    } else if (deadline) {
      deadlineText = `回應收集到：${deadline}`;
    }

    // 加入登入按鈕
    const body = `
      <p>${notifyContent}</p>
      <p>${deadlineText}</p>
      <p>版本號 ${version}</p>
      <div class="mt-3">
        <a href="/login/microsoft" class="btn btn-primary">用 Microsoft 登入</a>
      </div>
    `;
    document.getElementById("notifyBody").innerHTML = body;

    // 記錄已顯示的版本（放在函式內，確保 version 可用）
    try {
      localStorage.setItem("notifyVersion", version);
    } catch (e) {
      // 在私密/無痕模式 localStorage 可能會失敗
      console.warn("無法寫入 localStorage:", e);
    }

    new bootstrap.Modal(document.getElementById('notifyModal')).show();
  }

  // 頁面載入時 → 讀取設定並顯示通知
  window.onload = () => {
    fetch("/config")
      .then(res => res.json())
      .then(config => {
        showNotification(config);
      })
      .catch(err => {
        console.error("讀取 config 錯誤：", err);
      });
  };
  </script>
</body>
</html>
