<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>線上點歌表單</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="container mt-5">

  <h2 class="mb-4">線上點歌</h2>
  <form id="songForm">
    <div class="mb-3">
      <label for="name" class="form-label">姓名</label>
      <input type="text" class="form-control" id="name" required>
    </div>

    <div class="mb-3">
      <label for="gender" class="form-label">性別</label>
      <select class="form-select" id="gender" required>
        <option value="">請選擇</option>
        <option value="男">男</option>
        <option value="女">女</option>
      </select>
    </div>

    <!-- 歌曲名稱 + 建議清單 -->
    <div class="mb-3 position-relative">
      <label for="songName" class="form-label">歌曲名稱</label>
      <input type="text" class="form-control" id="songName" required>
      <!-- 建議清單會顯示在輸入框下方 -->
      <div id="songSuggestions" class="list-group position-absolute w-100" style="z-index:1000;"></div>
    </div>

    <div class="mb-3">
      <label for="songLink" class="form-label">Spotify 連結</label>
      <input type="url" class="form-control" id="songLink" required>
    </div>

    <button type="submit" class="btn btn-primary">送出</button>
  </form>

  <!-- 回應送出成功的 Modal -->
  <div class="modal fade" id="submitModal" tabindex="-1" aria-labelledby="submitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="modal-header justify-content-center">
          <h5 class="modal-title" id="submitModalLabel">✅ 您的回應已送出</h5>
        </div>
        <div class="modal-body">
          <p>將會整理請求及排列歌曲</p>
          <button class="btn btn-primary" onclick="location.reload()">提交其他回應</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 通知彈窗 -->
  <div class="modal fade" id="notifyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">通知</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="notifyBody" style="white-space: pre-line;"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">我知道了</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  // 表單送出
  document.getElementById("songForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const data = {
      name: document.getElementById("name").value,
      gender: document.getElementById("gender").value,
      songName: document.getElementById("songName").value,
      songLink: document.getElementById("songLink").value
    };

    fetch("/submit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const modal = new bootstrap.Modal(document.getElementById("submitModal"));
        modal.show();

        // 清空建議清單
        document.getElementById("songSuggestions").innerHTML = "";

        // 清空表單
        document.getElementById("songForm").reset();
      } else {
        alert("送出失敗：" + data.error);
      }
    });
  });

  // 即時 Spotify 搜尋建議
  document.getElementById("songName").addEventListener("input", function() {
    const query = this.value.trim();
    const box = document.getElementById("songSuggestions");
    if (!query) {
      box.innerHTML = "";
      return;
    }

    fetch(`/search?q=${encodeURIComponent(query)}`)
      .then(res => res.json())
      .then(data => {
        box.innerHTML = "";
        data.forEach(item => {
          const a = document.createElement("a");
          a.className = "list-group-item list-group-item-action";
          a.innerHTML = `<strong>${item.name}</strong> - ${item.artist}`;
          a.href = "#";
          a.onclick = (e) => {
            e.preventDefault();
            document.getElementById("songName").value = item.name;
            document.getElementById("songLink").value = item.url;
            box.innerHTML = "";
          };
          box.appendChild(a);
        });
      });
  });

  function showNotification(config) {
    const deadline = config.deadline || "";
    const notifyContent = config.notification_content || "";
    const version = config.version || "1.0.0";
  
    const shownVersion = localStorage.getItem("notifyVersion");
    if (shownVersion === version) {
      return;
    }
  
    let deadlineText = "";
    if (deadline.includes(" ")) {
      const [date, time] = deadline.split(" ");
      deadlineText = `回應收集到：${date} ${time}`;
    }

    // 加入登入按鈕
    const body = `
      <p>${notifyContent}</p>
      <p>${deadlineText}</p>
      <p>版本號 ${version}</p>
      <div class="mt-3">
        <a href="/login/microsoft" class="btn btn-primary">用 Microsoft 登入</a>
      </div>
    `;
    document.getElementById("notifyBody").innerHTML = body;
  
    new bootstrap.Modal(document.getElementById('notifyModal')).show();
    localStorage.setItem("notifyVersion", version);
  }
    // 記錄已顯示的版本
    localStorage.setItem("notifyVersion", version);
  }

  // 頁面載入時 → 讀取設定並顯示通知
  window.onload = () => {
    fetch("/config")
      .then(res => res.json())
      .then(config => {
        showNotification(config);
      });
  };
  </script>
</body>
</html>
