<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ç·šä¸Šé»æ­Œè¡¨å–®</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
  <style>
    /* 1. ç¾ä»£ç¯€æ…¶èƒŒæ™¯ï¼šæµå‹•æ¼¸è®Š */
    body.festival-mode {
      background: linear-gradient(-45deg, #4b0000, #800000, #d4af37, #600000);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      min-height: 100vh;
      color: #fff !important;
      transition: all 0.5s ease;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* 2. ä¸»å®¹å™¨æ¯›ç»ç’ƒæ•ˆæœ */
    body.festival-mode .container.mt-5 {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 40px;
      border: 1px solid rgba(212, 175, 55, 0.3);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
    }

    /* 3. ç™½ç³»ç»ç’ƒæ“¬æ…‹ (White Glass UI) */
    body.festival-mode .modal-content,
    body.festival-mode .navbar {
      background: rgba(255, 255, 255, 0.50) !important; 
      backdrop-filter: blur(20px) !important;
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.6) !important;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2) !important;
    }

    /* å½ˆçª—å°ˆå±¬èª¿æ•´ */
    body.festival-mode .modal-content {
      border-radius: 24px !important;
      color: #212529 !important;
    }

    body.festival-mode .modal-header, 
    body.festival-mode .modal-footer {
      border: none !important;
      background: transparent !important;
    }

    body.festival-mode .modal-title {
      color: #000 !important;
      font-weight: 800;
    }

    body.festival-mode .modal-header .btn-close {
      filter: none !important; 
    }

    /* 4. å°è¦½åˆ—ï¼ˆNavbarï¼‰å°ˆå±¬èª¿æ•´ */
    body.festival-mode .navbar {
      border-radius: 16px;
      margin-bottom: 2rem;
      padding: 0.8rem 1.2rem;
    }

    /* å°è¦½åˆ—æ¨™é¡Œå­—é«”å¤§å°èˆ‡é¡è‰² */
    body.festival-mode .navbar-brand {
      color: #800000 !important;
      font-weight: bold;
      text-shadow: none;
    }

    body.festival-mode .navbar-text {
      color: #333 !important;
      text-shadow: none;
    }

    /* 5. è¡¨å–®æ¨™ç±¤èˆ‡æ¨™é¡Œ (ç¶­æŒé‡‘è‰²äº®çœ¼æ„Ÿ) */
    body.festival-mode .form-label {
      color: #ffd700 !important;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }

    body.festival-mode h2 { 
      color: #ffd700; 
      font-weight: bold; 
    }

    /* 6. æŒ‰éˆ•æ¨£å¼å„ªåŒ– */
    body.festival-mode .btn-primary {
      border-radius: 12px;
      background: rgba(13, 110, 253, 0.9) !important;
      border: none !important;
    }

    /* 7. ç²’å­ç•«å¸ƒ */
    #festival-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    /* ç¯€æ…¶æ¨™é¡Œèˆ‡æŒ‰éˆ•æ–‡å­—åˆ‡æ› */
    .festival-title {
      transition: all 0.5s;
    }
    body.festival-mode .festival-title {
      color: #ffd700 !important;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5), 0 0 15px #ff4d4d;
      font-weight: 900;
    }

    .festival-text { display: none; }

    body.festival-mode .btn-primary {
      background: linear-gradient(135deg, #d40000 0%, #8b0000 100%) !important;
      border: 1px solid #ffd700 !important;
      min-height: 50px;
      font-weight: bold;
    }

    /* å›ºå®šç™»å…¥ã€ç™»å‡ºèˆ‡ç®¡ç†æŒ‰éˆ•çš„å¤§å° */
    .nav-btn-custom {
      min-width: 90px;
      height: 38px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    .form-check-label {
      transition: color 0.5s ease;
      cursor: pointer;
      user-select: none;
    }

    body.festival-mode #switchLabel {
      color: #800000 !important;
      font-weight: bold;
    }

    body.festival-mode .btn-primary .normal-text { display: none !important; }
    body.festival-mode .btn-primary .festival-text { display: inline-block !important; }

    /* èƒŒæ™¯ç•«å¸ƒçš„ Emoji æ•ˆæœ */
    #festival-canvas {
      filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.3));
    }

    /* æ‰‹æ©Ÿç‰ˆå°ˆå±¬å¾®èª¿ */
    @media (max-width: 768px) {
      /* è®“ä¸»å®¹å™¨æ›´å¯¬ï¼Œä¸è¦ç•™å…©å¤§ç‰‡ç©ºç™½ */
      body.festival-mode .container.mt-5 {
        padding: 20px 15px !important;
        margin-top: 10px !important;
        border-radius: 16px;
      }

      /* å°è¦½åˆ—æ”¹ç‚ºå‚ç›´æ’åˆ—ï¼Œé¿å…æ“ å£“ */
      .navbar .container-fluid {
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      /* éš±è—éé•·çš„ Emailï¼Œæˆ–è®“å®ƒæ›è¡Œ */
      .navbar-text {
        display: block;
        text-align: center;
        font-size: 0.8rem;
        margin: 5px 0 !important;
      }

      /* è®“æŒ‰éˆ•åœ¨æ‰‹æ©Ÿä¸Šæ›´å¤§æ›´å¥½æŒ‰ */
      .nav-btn-custom {
         width: 100%; /* ç™»å‡ºæŒ‰éˆ•æ’æ»¿ï¼Œæ–¹ä¾¿å¤§æ‹‡æŒ‡é»é¸ */
         height: 44px;
      }

      /* æ¨™é¡Œå­—é«”ç¸®æ”¾ï¼Œé¿å…æ›è¡Œå¤ªçªå…€ */
      .festival-title {
        font-size: 1.4rem !important;
      }

      /* Spotify é€£çµé ç•™å­—æ¨£ç¸®å° */
      input::placeholder {
        font-size: 0.8rem;
      }
    }

  </style>

<body class="container mt-5">
  <canvas id="festival-canvas"></canvas>

  <!-- å°è¦½åˆ— -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="{{ url_for('index') }}">ç·šä¸Šé»æ­Œè¡¨å–®</a>
    
      <div class="d-flex align-items-center">
      
        <div class="form-check form-switch me-3">
          <input class="form-check-input" type="checkbox" id="festivalSwitch" role="switch">
          <label class="form-check-label text-secondary" for="festivalSwitch" id="switchLabel" style="font-size: 0.85rem;">ç¯€æ…¶æ¨¡å¼</label>
        </div>

        {% if session.get("user") %}
          <span class="navbar-text me-3 d-none d-md-inline">ç›®å‰ï¼š{{ session["user"].get("email") }}</span>
          <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary btn-sm nav-btn-custom">ç™»å‡º</a>
        {% else %}
          <a href="#" class="btn btn-primary btn-sm nav-btn-custom" data-bs-toggle="modal" data-bs-target="#loginModal">ç™»å…¥</a>
        {% endif %}

        {% if session.get("user") and session["user"]["email"] in ADMIN_EMAILS %}
           <a href="{{ url_for('admin_page') }}" class="btn btn-warning btn-sm nav-btn-custom ms-2">ç®¡ç†é é¢</a>
        {% endif %}
      </div>
    </div>
  </nav>

  <h2 class="mb-4 text-center festival-title">
    <span class="emoji-decor">ğŸ§¨</span> 
    æ–°æ˜¥é»æ­Œ â€§ å¤§å‰å¤§åˆ© 
    <span class="emoji-decor">ğŸ§§</span>
  </h2>

  <!-- ç‹€æ…‹é¡¯ç¤ºå€å¡Š -->
  <div id="statusBox" class="mb-3"></div>
  <form id="songForm">
    <div class="mb-3">
      <label for="name" class="form-label">å§“å</label>
      <input type="text" class="form-control" id="name" name="name" required>
    </div>

    <div class="mb-3">
      <label for="gender" class="form-label">æ€§åˆ¥</label>
      <select class="form-select" id="gender" name="gender" required>
        <option value="">è«‹é¸æ“‡</option>
        <option value="ç”·">ç”·</option>
        <option value="å¥³">å¥³</option>
      </select>
    </div>

    <!-- æ­Œæ›²åç¨± + å»ºè­°æ¸…å–® -->
    <div class="mb-3 position-relative">
      <label for="songName" class="form-label">æ­Œæ›²åç¨±</label>
      <input type="text" class="form-control" id="songName" name="songName" required aria-autocomplete="list" aria-controls="songSuggestions">
      <div id="songSuggestions" class="list-group position-absolute w-100" style="z-index:1000;" role="listbox"></div>
    </div>

    <div class="mb-3">
      <label for="songLink" class="form-label">Spotify é€£çµ</label>
      <input type="url" class="form-control" id="songLink" name="songLink" required placeholder="https://open.spotify.com/...">
    </div>

    <button type="submit" class="btn btn-primary w-100 py-2">
      <span class="normal-text">é€å‡ºå›æ‡‰</span>
      <span class="festival-text">ğŸ§§ é–‹é‹é€å‡º ğŸ§§</span>
    </button>
  </form>

  <!-- å›æ‡‰é€å‡ºæˆåŠŸçš„ Modal -->
  <div class="modal fade" id="submitModal" tabindex="-1" aria-labelledby="submitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="modal-header justify-content-center">
          <h5 class="modal-title" id="submitModalLabel">âœ… æ‚¨çš„å›æ‡‰å·²é€å‡º</h5>
        </div>
        <div class="modal-body">
          <p>å°‡æœƒæ•´ç†è«‹æ±‚åŠæ’åˆ—æ­Œæ›²</p>
          <button class="btn btn-primary" onclick="location.reload()">æäº¤å…¶ä»–å›æ‡‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- é€šçŸ¥å½ˆçª— -->
  <div class="modal fade" id="notifyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">é€šçŸ¥</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="notifyBody" style="white-space: pre-line;">
          {% if not session.get("user") %}
            <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">ç™»å…¥</a>
          {% endif %}
        </div>
        <div class="modal-footer">
          {% if session.get("user") %}
            <span class="me-2 text-success">æ‚¨å·²ç™»å…¥ï¼š{{ session["user"]["email"] }}</span>
          {% endif %}
          <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">æˆ‘çŸ¥é“äº†</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç™»å…¥é¸æ“‡å½ˆçª— -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">é¸æ“‡ç™»å…¥æ–¹å¼</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <a href="{{ url_for('login_microsoft') }}" class="btn btn-primary w-100 mb-2">ä½¿ç”¨ Microsoft ç™»å…¥</a>
          <a href="{{ url_for('login_google') }}" class="btn btn-danger w-100 mb-2">ä½¿ç”¨ Google ç™»å…¥</a>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // ç²’å­å‹•ç•«èˆ‡ä¸»é¡Œé–‹é—œé‚è¼¯
    const festivalSwitch = document.getElementById('festivalSwitch');

    function initFestivalEffect() {
      const now = new Date();
      const isFebruary = now.getMonth() === 1; // åµæ¸¬æ˜¯å¦ç‚º 2 æœˆ
      
      // è®€å–ç€è¦½å™¨å„²å­˜çš„åå¥½ (localStorage)
      const savedPref = localStorage.getItem('festivalEnabled');
      
      // æ±ºå®šè¦å‰‡ï¼šå¦‚æœæœ‰å­˜éè¨­å®šå°±ç”¨è¨­å®šï¼Œæ²’å­˜éå°±çœ‹æœˆä»½ (é è¨­é–‹å•Ÿ)
      const shouldEnable = (savedPref === null) ? isFebruary : (savedPref === 'true');

      // è¨­å®šé–‹é—œæŒ‰éˆ•ç‹€æ…‹
      festivalSwitch.checked = shouldEnable;
      
      // åŸ·è¡Œåˆ‡æ›æ¨¡å¼
      applyFestivalMode(shouldEnable);
    }

    function applyFestivalMode(enable) {
      if (enable) {
        document.body.classList.add('festival-mode');
        document.getElementById('festival-canvas').style.display = 'block';
        startParticles();
      } else {
        document.body.classList.remove('festival-mode');
        document.getElementById('festival-canvas').style.display = 'none';
      }
      // å°‡ä½¿ç”¨è€…çš„é¸æ“‡å­˜å…¥ localStorage
      localStorage.setItem('festivalEnabled', enable);
    }

    // ç›£è½é–‹é—œæ’¥å‹•å‹•ä½œ
    festivalSwitch.addEventListener('change', (e) => {
      const isEnabled = e.target.checked;
      applyFestivalMode(isEnabled);
      
      // å¦‚æœä½¿ç”¨è€…é–‹å•Ÿä¸»é¡Œï¼Œé‡æ–°æ•´ç†é é¢ä»¥ç¢ºä¿ Canvas ç²’å­å‹•ç•«ä¹¾æ·¨åˆå§‹åŒ–
      if (isEnabled) {
        location.reload();
      }
    });

    function startParticles() {
      const canvas = document.getElementById('festival-canvas');
      const ctx = canvas.getContext('2d');
      let particles = [];

      function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      window.addEventListener('resize', resize);
      resize();

      // å®šç¾© Emoji é¡åˆ¥
      class FestivalEmoji {
        constructor() {
          this.emojis = ['ğŸ§§', 'ğŸŠ', 'ğŸ§¨', 'ğŸ’°', 'âœ¨', 'ğŸ®']; // éå¹´è²¼åœ–æ± 
          this.reset();
        }
        reset() {
          this.x = Math.random() * canvas.width;
          this.y = Math.random() * -canvas.height;
          this.emoji = this.emojis[Math.floor(Math.random() * this.emojis.length)];
          this.fontSize = Math.random() * 20 + 10; // å¤§å° 10px åˆ° 30px
          this.speedY = Math.random() * 1.5 + 0.8; // ä¸‹å¢œé€Ÿåº¦
          this.speedX = Math.random() * 1 - 0.5;   // å·¦å³é£„ç§»
          this.opacity = Math.random() * 0.5 + 0.5; // é€æ˜åº¦
          this.rotation = Math.random() * 360;      // åˆå§‹æ—‹è½‰è§’åº¦
          this.rotationSpeed = Math.random() * 2 - 1; // æ—‹è½‰é€Ÿåº¦
        }
        update() {
          this.y += this.speedY;
          this.x += this.speedX;
          this.rotation += this.rotationSpeed;
          if (this.y > canvas.height) this.reset();
        }
        draw() {
          ctx.save();
          ctx.globalAlpha = this.opacity;
          ctx.font = `${this.fontSize}px serif`;
          ctx.translate(this.x, this.y);
          ctx.rotate(this.rotation * Math.PI / 180);
          ctx.fillText(this.emoji, 0, 0);
          ctx.restore();
        }
      }

      // ç”Ÿæˆ 50 å€‹æ¼‚æµ®ç‰©
      for (let i = 0; i < 50; i++) particles.push(new FestivalEmoji());

      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => { p.update(); p.draw(); });
        requestAnimationFrame(animate);
      }
      animate();
    }

    // --- ç²’å­é‚è¼¯çµæŸ ---

    // è¡¨å–®é€å‡º
    document.getElementById("songForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const data = {
        name: document.getElementById("name").value,
        gender: document.getElementById("gender").value,
        songName: document.getElementById("songName").value,
        songLink: document.getElementById("songLink").value
      };
      fetch("/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const modal = new bootstrap.Modal(document.getElementById("submitModal"));
          modal.show();
          document.getElementById("songSuggestions").innerHTML = "";
          document.getElementById("songForm").reset();
        } else {
          alert("é€å‡ºå¤±æ•—ï¼š" + data.error);
        }
      })
      .catch(err => {
        console.error("æäº¤å¤±æ•—ï¼š", err);
        alert("é€å‡ºç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      });
    });

    // æª¢æŸ¥é™åˆ¶å‡½å¼
    function checkStatus() {
      const name = document.getElementById("name").value.trim();
      const gender = document.getElementById("gender").value;

      fetch(`/status?name=${encodeURIComponent(name)}&gender=${encodeURIComponent(gender)}`)

      fetch(`/status?name=${encodeURIComponent(name)}&gender=${encodeURIComponent(gender)}`)
        .then(res => res.json())
        .then(data => {
          const box = document.getElementById("statusBox");
          let html = "";

          if (!data.accept_responses) {
            html = `<div class="alert alert-danger"><h3>ç›®å‰ä¸æ¥å—å›æ‡‰</h3></div>`;
            document.getElementById("songForm").style.display = "none";
          } 
          else if (data.deadline && new Date() > new Date(data.deadline)) {
            html = `<div class="alert alert-warning"><h3>å·²è¶…éæˆªæ­¢æ™‚é–“</h3></div>`;
            document.getElementById("songForm").style.display = "none";
          } 
          else if (data.remaining !== null && data.remaining <= 0) {
            html = `<div class="alert alert-danger"><h3>å·²é”é»æ­Œä¸Šé™</h3></div>`;
            document.getElementById("songForm").style.display = "none";
          } 
          else if (data.remaining !== null) {
            html = `<div class="alert alert-info">
                      ä½ é‚„å¯ä»¥å†é» ${data.remaining} é¦–æ­Œ
                    </div>`;
            document.getElementById("songForm").style.display = "block";
          }

          box.innerHTML = html;
        });
    }

    // ç¶å®šäº‹ä»¶
    document.getElementById("name").addEventListener("change", checkStatus);
    document.getElementById("gender").addEventListener("change", () => {
      const name = document.getElementById("name").value.trim();
      const gender = document.getElementById("gender").value;

      if (gender) {
        localStorage.setItem("savedName", name);
        localStorage.setItem("savedGender", gender);
      }

      checkStatus();
    });
    
    // å³æ™‚ Spotify æœå°‹å»ºè­°
    document.getElementById("songName").addEventListener("input", function() {
      const query = this.value.trim();
      const box = document.getElementById("songSuggestions");
      if (!query) {
        box.innerHTML = "";
        return;
      }
      fetch(`/search?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          box.innerHTML = "";
          data.forEach((item, idx) => {
            const a = document.createElement("a");
            a.className = "list-group-item list-group-item-action";
            a.setAttribute("role", "option");
            a.setAttribute("id", "suggestion-" + idx);
            a.innerHTML = `<strong>${item.name}</strong> - ${item.artist}`;
            a.href = "#";
            a.onclick = (e) => {
              e.preventDefault();
              document.getElementById("songName").value = item.name;
              document.getElementById("songLink").value = item.url;
              box.innerHTML = "";
            };
            box.appendChild(a);
          });
        })
        .catch(err => {
          console.error("æœå°‹å»ºè­°éŒ¯èª¤ï¼š", err);
        });
    });

    // é€šçŸ¥é¡¯ç¤º
    function showNotification(config) {
      const deadline = config.deadline || "";
      const notifyContent = config.notification_content || "";
      const version = config.version || "1.0.0";

      let deadlineText = "";
      if (deadline && deadline.includes(" ")) {
        const [date, time] = deadline.split(" ");
        deadlineText = `å›æ‡‰æ”¶é›†åˆ°ï¼š${date} ${time}`;
      } else if (deadline) {
        deadlineText = `å›æ‡‰æ”¶é›†åˆ°ï¼š${deadline}`;
      }

      let loginText = "";
      {% if session.get("user") %}
        loginText = "æ‚¨å·²ç™»å…¥ï¼š" + "{{ session['user']['email'] }}";
      {% endif %}
      
      const body = `
        <p>${notifyContent}</p>
        <p>${deadlineText}</p>
        <p>ç‰ˆæœ¬è™Ÿ ${version}</p>
        <div class="mt-3">
          <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">ç™»å…¥</a>
        </div>
      `;
      document.getElementById("notifyBody").innerHTML = body;

      try {
        localStorage.setItem("notifyVersion", version);
      } catch (e) {
        console.warn("ç„¡æ³•å¯«å…¥ localStorage:", e);
      }

      new bootstrap.Modal(document.getElementById('notifyModal')).show();
    }

    // é é¢è¼‰å…¥æ™‚
    window.onload = () => {
      // 1. åˆå§‹åŒ–ç¯€æ…¶æ•ˆæœ
      initFestivalEffect();

      // 2. è®€å–ä¹‹å‰å„²å­˜çš„èº«ä»½
      const savedName = localStorage.getItem("savedName");
      const savedGender = localStorage.getItem("savedGender");

      if (savedName) {
        document.getElementById("name").value = savedName;
      }

      if (savedGender) {
        document.getElementById("gender").value = savedGender;
      }

      // 3. ä¸€é€²é é¢å°±è¨ˆç®—
      checkStatus();
      
      // 4. å…ˆé¡¯ç¤ºé€šçŸ¥
      fetch("/config")
        .then(res => res.json())
        .then(config => {
          showNotification(config);
        })
        .catch(err => {
          console.error("è®€å– config éŒ¯èª¤ï¼š", err);
        });
      
    };
  </script>
