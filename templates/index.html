<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æ˜¥å­£é»æ­Œè¡¨å–®</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<head>
  <style>
    /* 1. 3æœˆæ˜¥å­£ä¸»é¡Œï¼šæ«»èŠ±ç²‰ã€å«©è‘‰ç¶ èˆ‡å¤©ç©ºè—æ¼¸è®Š */
    body.festival-mode {
      background: linear-gradient(-45deg, #fff5f7, #ffd1dc, #e2f0d9, #e0f2f1);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      min-height: 100vh;
      color: #333 !important; /* æ˜¥å­£èƒŒæ™¯è¼ƒäº®ï¼Œæ”¹ç”¨æ·±è‰²å­— */
      transition: all 0.5s ease;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* 2. ä¸»å®¹å™¨ï¼šæ¸…çˆ½çš„ç™½è‰²åŠé€æ˜æ¯›ç»ç’ƒ */
    body.festival-mode .container.mt-5 {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 24px;
      padding: 40px;
      border: 1px solid rgba(255, 182, 193, 0.5); /* æ«»èŠ±ç²‰é‚Šæ¡† */
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.05);
    }

    /* 3. ç»ç’ƒæ“¬æ…‹æ¨£å¼ (Modal & Navbar) */
    body.festival-mode .modal-content,
    body.festival-mode .navbar {
      background: rgba(255, 255, 255, 0.7) !important; 
      backdrop-filter: blur(20px) !important;
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.8) !important;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1) !important;
    }

    /* 4. æ¨™é¡Œèˆ‡æ¨™ç±¤å°ˆå±¬é¡è‰² */
    .festival-title { transition: all 0.5s; }
    body.festival-mode .festival-title {
      color: #d85d7c !important; /* æ«»èŠ±æ·±ç²‰ */
      text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.8);
      font-weight: 900;
    }

    body.festival-mode .form-label {
      color: #5a8d5a !important; /* æ£®æ—å«©ç¶  */
      font-weight: bold;
      text-shadow: none;
    }

    /* 5. æŒ‰éˆ•åˆ‡æ›é‚è¼¯ (æ˜¥å­£ç¶ è‰²æ¼¸è®Š) */
    .festival-text { display: none; }
    .normal-text { display: inline; }

    body.festival-mode .btn-primary {
      background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%) !important;
      border: none !important;
      min-height: 50px;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(86, 171, 47, 0.2);
    }

    body.festival-mode .btn-primary .normal-text { display: none !important; }
    body.festival-mode .btn-primary .festival-text { display: inline-block !important; }

    /* 6. ç²’å­ç•«å¸ƒ */
    #festival-canvas {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    @media (max-width: 576px) {
      .emoji-decor { font-size: 0.8em; }
    }
  </style>

<body class="container mt-5">
  <canvas id="festival-canvas"></canvas>

  <!-- å°è¦½åˆ— -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="{{ url_for('index') }}">ç·šä¸Šé»æ­Œè¡¨å–®</a>
      <div class="d-flex">
        {% if session.get("user") %}
          <span class="navbar-text me-2">ç›®å‰ç™»å…¥ï¼š{{ session["user"].get("email") }}</span>
          <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary btn-sm">ç™»å‡º</a>
        {% else %}
          <a href="#" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#loginModal">ç™»å…¥</a>
        {% endif %}
        {% if session.get("user") and session["user"]["email"] in ADMIN_EMAILS %}
          <a href="{{ url_for('admin_page') }}" class="btn btn-warning btn-sm">ç®¡ç†é é¢</a>
        {% endif %}
      </div>
    </div>
  </nav>

  <h2 class="mb-4 text-center festival-title">
    <span class="emoji-decor">ğŸŒ¸</span> 
    æ˜¥æš–èŠ±é–‹ â€§ é»æ­Œæ™‚å…‰ 
    <span class="emoji-decor">ğŸŒ±</span>
  </h2>

  <div id="statusBox" class="mb-3"></div>
  
  <form id="songForm">
    <div class="mb-3">
      <label for="name" class="form-label">å§“å</label>
      <input type="text" class="form-control" id="name" name="name" required>
    </div>

    <div class="mb-3">
      <label for="gender" class="form-label">æ€§åˆ¥</label>
      <select class="form-select" id="gender" name="gender" required>
        <option value="">è«‹é¸æ“‡</option>
        <option value="ç”·">ç”·</option>
        <option value="å¥³">å¥³</option>
      </select>
    </div>

    <div class="mb-3 position-relative">
      <label for="songName" class="form-label">æ­Œæ›²åç¨±</label>
      <input type="text" class="form-control" id="songName" name="songName" required aria-autocomplete="list" aria-controls="songSuggestions">
      <div id="songSuggestions" class="list-group position-absolute w-100" style="z-index:1000;" role="listbox"></div>
    </div>

    <div class="mb-3">
      <label for="songLink" class="form-label">Spotify é€£çµ</label>
      <input type="url" class="form-control" id="songLink" name="songLink" required placeholder="http://spotify.com/...">
    </div>

    <button type="submit" class="btn btn-primary w-100 py-2">
      <span class="normal-text">é€å‡ºå›æ‡‰</span>
      <span class="festival-text">ğŸŒ¸ æ˜¥å­£é–‹é‹é€å‡º ğŸŒ¸</span>
    </button>
  </form>

  <!-- å›æ‡‰é€å‡ºæˆåŠŸçš„ Modal -->
  <div class="modal fade" id="submitModal" tabindex="-1" aria-labelledby="submitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="modal-header justify-content-center">
          <h5 class="modal-title" id="submitModalLabel">âœ… æ‚¨çš„å›æ‡‰å·²é€å‡º</h5>
        </div>
        <div class="modal-body">
          <p>å°‡æœƒæ•´ç†è«‹æ±‚åŠæ’åˆ—æ­Œæ›²</p>
          <button class="btn btn-primary" onclick="location.reload()">æäº¤å…¶ä»–å›æ‡‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- é€šçŸ¥å½ˆçª— -->
  <div class="modal fade" id="notifyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">é€šçŸ¥</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="notifyBody" style="white-space: pre-line;">
          {% if not session.get("user") %}
            <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">ç™»å…¥</a>
          {% endif %}
        </div>
        <div class="modal-footer">
          {% if session.get("user") %}
            <span class="me-2 text-success">æ‚¨å·²ç™»å…¥ï¼š{{ session["user"]["email"] }}</span>
          {% endif %}
          <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">æˆ‘çŸ¥é“äº†</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç™»å…¥é¸æ“‡å½ˆçª— -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">é¸æ“‡ç™»å…¥æ–¹å¼</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <a href="{{ url_for('login_microsoft') }}" class="btn btn-primary w-100 mb-2">ä½¿ç”¨ Microsoft ç™»å…¥</a>
          <a href="{{ url_for('login_google') }}" class="btn btn-danger w-100 mb-2">ä½¿ç”¨ Google ç™»å…¥</a>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // --- [ä¿®æ­£] 3æœˆæ˜¥å­£ç²’å­èˆ‡é‚è¼¯ ---
    function initFestivalEffect() {
      const now = new Date();
      if (now.getMonth() === 2 || now.getMonth() === 1) { 
        document.body.classList.add('festival-mode');
        startParticles();
      }
    }

    function startParticles() {
      const canvas = document.getElementById('festival-canvas');
      const ctx = canvas.getContext('2d');
      let particles = [];

      function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      window.addEventListener('resize', resize);
      resize();

      class SpringEmoji {
        constructor() {
          this.emojis = ['ğŸŒ¸', 'ğŸƒ', 'ğŸŒ·', 'ğŸŒ±', 'ğŸ¦‹', 'âœ¨']; 
          this.reset();
        }
        reset() {
          this.x = Math.random() * canvas.width;
          this.y = Math.random() * -canvas.height;
          this.emoji = this.emojis[Math.floor(Math.random() * this.emojis.length)];
          this.fontSize = Math.random() * 15 + 10;
          this.speedY = Math.random() * 0.7 + 0.4; // æ…¢é€Ÿæ‰è½
          this.speedX = Math.random() * 1.2 - 0.6; // éš¨é¢¨å·¦å³æ“ºå‹•
          this.opacity = Math.random() * 0.5 + 0.4;
          this.rotation = Math.random() * 360;
          this.rotationSpeed = Math.random() * 1.5 - 0.75;
        }
        update() {
          this.y += this.speedY;
          this.x += this.speedX;
          this.rotation += this.rotationSpeed;
          if (this.y > canvas.height) this.reset();
        }
        draw() {
          ctx.save();
          ctx.globalAlpha = this.opacity;
          ctx.font = `${this.fontSize}px serif`;
          ctx.translate(this.x, this.y);
          ctx.rotate(this.rotation * Math.PI / 180);
          ctx.fillText(this.emoji, 0, 0);
          ctx.restore();
        }
      }

      for (let i = 0; i < 40; i++) particles.push(new SpringEmoji());

      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        particles.forEach(p => { p.update(); p.draw(); });
        requestAnimationFrame(animate);
      }
      animate();
    }

    // --- ç²’å­é‚è¼¯çµæŸ ---

    // è¡¨å–®é€å‡º
    document.getElementById("songForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const data = {
        name: document.getElementById("name").value,
        gender: document.getElementById("gender").value,
        songName: document.getElementById("songName").value,
        songLink: document.getElementById("songLink").value
      };
      fetch("/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const modal = new bootstrap.Modal(document.getElementById("submitModal"));
          modal.show();
          document.getElementById("songSuggestions").innerHTML = "";
          document.getElementById("songForm").reset();
        } else {
          alert("é€å‡ºå¤±æ•—ï¼š" + data.error);
        }
      })
      .catch(err => {
        console.error("æäº¤å¤±æ•—ï¼š", err);
        alert("é€å‡ºç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      });
    });

    // å³æ™‚ Spotify æœå°‹å»ºè­°
    document.getElementById("songName").addEventListener("input", function() {
      const query = this.value.trim();
      const box = document.getElementById("songSuggestions");
      if (!query) {
        box.innerHTML = "";
        return;
      }
      fetch(`/search?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          box.innerHTML = "";
          data.forEach((item, idx) => {
            const a = document.createElement("a");
            a.className = "list-group-item list-group-item-action";
            a.setAttribute("role", "option");
            a.setAttribute("id", "suggestion-" + idx);
            a.innerHTML = `<strong>${item.name}</strong> - ${item.artist}`;
            a.href = "#";
            a.onclick = (e) => {
              e.preventDefault();
              document.getElementById("songName").value = item.name;
              document.getElementById("songLink").value = item.url;
              box.innerHTML = "";
            };
            box.appendChild(a);
          });
        })
        .catch(err => {
          console.error("æœå°‹å»ºè­°éŒ¯èª¤ï¼š", err);
        });
    });

    // é€šçŸ¥é¡¯ç¤º
    function showNotification(config) {
      const deadline = config.deadline || "";
      const notifyContent = config.notification_content || "";
      const version = config.version || "1.0.0";

      let deadlineText = "";
      if (deadline && deadline.includes(" ")) {
        const [date, time] = deadline.split(" ");
        deadlineText = `å›æ‡‰æ”¶é›†åˆ°ï¼š${date} ${time}`;
      } else if (deadline) {
        deadlineText = `å›æ‡‰æ”¶é›†åˆ°ï¼š${deadline}`;
      }

      let loginText = "";
      {% if session.get("user") %}
        loginText = "æ‚¨å·²ç™»å…¥ï¼š" + "{{ session['user']['email'] }}";
      {% endif %}
      
      const body = `
        <p>${notifyContent}</p>
        <p>${deadlineText}</p>
        <p>ç‰ˆæœ¬è™Ÿ ${version}</p>
        <div class="mt-3">
          <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">ç™»å…¥</a>
        </div>
      `;
      document.getElementById("notifyBody").innerHTML = body;

      try {
        localStorage.setItem("notifyVersion", version);
      } catch (e) {
        console.warn("ç„¡æ³•å¯«å…¥ localStorage:", e);
      }

      new bootstrap.Modal(document.getElementById('notifyModal')).show();
    }

    // é é¢è¼‰å…¥æ™‚
    window.onload = () => {
      // 1. åˆå§‹åŒ–ç¯€æ…¶æ•ˆæœ
      initFestivalEffect();

      // 2. å…ˆé¡¯ç¤ºé€šçŸ¥
      fetch("/config")
        .then(res => res.json())
        .then(config => {
          showNotification(config);
        })
        .catch(err => {
          console.error("è®€å– config éŒ¯èª¤ï¼š", err);
        });
      
      // 3. å†é¡¯ç¤ºç³»çµ±ç‹€æ…‹
      fetch("/status")
        .then(res => res.json())
        .then(data => {
          const box = document.getElementById("statusBox");
          let html = "";

          if (!data.accept_responses) {
            html = `<div class="alert alert-danger"><h3>ç›®å‰ä¸æ¥å—å›æ‡‰</h3></div>`;
            document.getElementById("songForm").style.display = "none";
          } else if (data.deadline && new Date() > new Date(data.deadline)) {
            html = `<div class="alert alert-warning"><h3>å·²è¶…éæˆªæ­¢æ™‚é–“</h3></div>`;
            document.getElementById("songForm").style.display = "none";
          } else if (data.remaining !== null && data.remaining <= 0) {
            html = `<div class="alert alert-danger"><h3>å·²é”é»æ­Œä¸Šé™</h3></div>`;
            document.getElementById("songForm").style.display = "none";
          } else if (data.remaining !== null) {
            html = `<div class="alert alert-info"><p>ä½ é‚„å¯ä»¥å†é» ${data.remaining} é¦–æ­Œ</p></div>`;
          }

          box.innerHTML = html;
        })
        .catch(err => {
          console.error("è®€å– status éŒ¯èª¤ï¼š", err);
        });
    };
  </script>
    </div>
      `;
      document.getElementById("notifyBody").innerHTML = body;

      try {
        localStorage.setItem("notifyVersion", version);
      } catch (e) {
        console.warn("ç„¡æ³•å¯«å…¥ localStorage:", e);
      }

      new bootstrap.Modal(document.getElementById('notifyModal')).show();
    }

    window.onload = () => {
      // 1. åˆå§‹åŒ– 3 æœˆæ˜¥å­£ç‰¹æ•ˆ
      initFestivalEffect();

      // 2. é¡¯ç¤ºé€šçŸ¥å½ˆçª—
      fetch("/config")
        .then(res => res.json())
        .then(config => {
          showNotification(config);
        })
        .catch(err => console.error("è®€å– config éŒ¯èª¤ï¼š", err));
      
      // 3. é¡¯ç¤ºç›®å‰ç³»çµ±ç‹€æ…‹ï¼ˆé»æ­Œä¸Šé™èˆ‡æˆªæ­¢æ™‚é–“ï¼‰
      fetch("/status")
        .then(res => res.json())
        .then(data => {
          const box = document.getElementById("statusBox");
          let html = "";

          if (!data.accept_responses) {
            html = `<div class="alert alert-danger"><h3>ç›®å‰ä¸æ¥å—å›æ‡‰</h3></div>`;
            document.getElementById("songForm").style.display = "none";
          } else if (data.deadline && new Date() > new Date(data.deadline)) {
            html = `<div class="alert alert-warning"><h3>å·²è¶…éæˆªæ­¢æ™‚é–“</h3></div>`;
            document.getElementById("songForm").style.display = "none";
          } else if (data.remaining !== null && data.remaining <= 0) {
            html = `<div class="alert alert-danger"><h3>å·²é”é»æ­Œä¸Šé™</h3></div>`;
            document.getElementById("songForm").style.display = "none";
          } else if (data.remaining !== null) {
            // ä½¿ç”¨åå¼•è™Ÿæ­£ç¢ºåµŒå…¥è®Šæ•¸
            html = `<div class="alert alert-info"><p>ä½ é‚„å¯ä»¥å†é» ${data.remaining} é¦–æ­Œ</p></div>`;
          }
          box.innerHTML = html;
        })
        .catch(err => console.error("è®€å– status éŒ¯èª¤ï¼š", err));
    };
  </script>
</body>
</html>
